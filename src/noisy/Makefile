TREEROOT	= ../..

include		$(TREEROOT)/config.local

PRECOMMITHOOK = precommitStatisticsHook-$(OSTYPE).sh 
COMMONPATH	= ../common
EXAMPLESPATH	= ../../applications/noisy

COMPILERVARIANT	= gcc

LLVM_CONFIG?=llvm-config

SYSNAME		= Noisy
SYSNAMELOWER	= noisy
include		$(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT)
include		$(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT)

PLATFORM_CFLAGS	+= -Wno-gnu-designator
MAKEFLAGS	+= #-j -c
EXAMPLES_NEWTON_FLAGS = #-O 1#--verbose 1
LLVMCFLAGS	+= $(shell $(LLVM_CONFIG) --cflags)
LLVMLDFLAGS	+= $(shell $(LLVM_CONFIG) --cxxflags --ldflags --libs core bitwriter coroutines --system-libs)

CCFLAGS		= $(PLATFORM_DBGFLAGS) $(LLVMCFLAGS) $(PLATFORM_CFLAGS) $(PLATFORM_DFLAGS) $(PLATFORM_OPTFLAGS) 
LDFLAGS 	= $(PLATFORM_DBGFLAGS) $(LLVMLDFLAGS) -lm $(PLATFORM_LFLAGS) `pkg-config --libs 'libprotobuf-c >= 1.0.0'`

LIBNOISY	= Noisy
NOISY_L10N	= EN

#	-std=gnu99 because we use anonymous unions and induction variable defintions in loop head.
CCFLAGS		+= -std=gnu99 -DkNoisyL10N="\"$(NOISY_L10N)\"" -DNOISY_L10N_EN

TARGET		= noisy-$(OSTYPE)-$(NOISY_L10N)
CGI_TARGET	= noisycgi-$(OSTYPE)-$(NOISY_L10N)

WFLAGS		= -Wall -Werror
INCDIRS		= -I. -I$(LIBFLEXPATH) -I$(COMMONPATH) 
LINKDIRS	= -L. -L$(LIBFLEXPATH) -L$(COMMONPATH) -lCommon-$(OSTYPE)-EN
PROTOC		= protoc-c

NOISYEXTENSION	= n

SOURCES		=\
		version.c\
		main.c\
		cgimain.c\
		noisy.pb-c.c\
		noisy-typeSignatures.c\
		noisy-productions.c\
		noisy-tokens.c\
		noisy-types.c\
		noisy-lexer.c\
		noisy-parser.c\
		noisy-irHelpers.c\
		noisy-ffi2code-autoGeneratedSets.c\
		noisy-irPass-dotBackend.c\
		noisy-irPass-protobufBackend.c\
		noisy-timeStamps.c\
		noisy-typeCheck.c\
		noisy-codeGeneration.c\

#
#	Clang seems to be unable to do LTO unless we have all the objects
#	_not_ tucked into a library, so we don't just simply link main against
#	-l$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N)
#
OBJS		=\
		version.$(OBJECTEXTENSION)\
		main.$(OBJECTEXTENSION)\
		noisy.pb-c.$(OBJECTEXTENSION)\
		noisy-typeSignatures.$(OBJECTEXTENSION)\
		noisy-productions.$(OBJECTEXTENSION)\
		noisy-tokens.$(OBJECTEXTENSION)\
		noisy-types.$(OBJECTEXTENSION)\
		noisy-timeStamps.$(OBJECTEXTENSION)\
		noisy-lexer.$(OBJECTEXTENSION)\
		noisy-parser.$(OBJECTEXTENSION)\
		noisy-ffi2code-autoGeneratedSets.$(OBJECTEXTENSION)\
		noisy-irHelpers.$(OBJECTEXTENSION)\
		noisy-irPass-dotBackend.$(OBJECTEXTENSION)\
		noisy-irPass-protobufBackend.$(OBJECTEXTENSION)\
		noisy-typeCheck.$(OBJECTEXTENSION)\
		noisy-codeGeneration.$(OBJECTEXTENSION)\


#
#	Clang seems to be unable to do LTO unless we have all the objects
#	not tucked into a library, so we don't just simply link main against
#	-l$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N)
#
CGIOBJS		=\
		version.$(OBJECTEXTENSION)\
		cgimain.$(OBJECTEXTENSION)\
		noisy.pb-c.$(OBJECTEXTENSION)\
		noisy-typeSignatures.$(OBJECTEXTENSION)\
		noisy-productions.$(OBJECTEXTENSION)\
		noisy-tokens.$(OBJECTEXTENSION)\
		noisy-types.$(OBJECTEXTENSION)\
		noisy-timeStamps.$(OBJECTEXTENSION)\
		noisy-lexer.$(OBJECTEXTENSION)\
		noisy-parser.$(OBJECTEXTENSION)\
		noisy-ffi2code-autoGeneratedSets.$(OBJECTEXTENSION)\
		noisy-irHelpers.$(OBJECTEXTENSION)\
		noisy-irPass-dotBackend.$(OBJECTEXTENSION)\
		noisy-irPass-protobufBackend.$(OBJECTEXTENSION)\
		# noisy-codeGeneration.$(OBJECTEXTENSION)\


LIBNOISYOBJS =\
		version.$(OBJECTEXTENSION)\
		noisy.pb-c.$(OBJECTEXTENSION)\
		noisy-typeSignatures.$(OBJECTEXTENSION)\
		noisy-productions.$(OBJECTEXTENSION)\
		noisy-tokens.$(OBJECTEXTENSION)\
		noisy-types.$(OBJECTEXTENSION)\
		noisy-timeStamps.$(OBJECTEXTENSION)\
		noisy-lexer.$(OBJECTEXTENSION)\
		noisy-parser.$(OBJECTEXTENSION)\
		noisy-ffi2code-autoGeneratedSets.$(OBJECTEXTENSION)\
		noisy-irHelpers.$(OBJECTEXTENSION)\
		noisy-irPass-dotBackend.$(OBJECTEXTENSION)\
		noisy-irPass-protobufBackend.$(OBJECTEXTENSION)\
		# noisy-codeGeneration.$(OBJECTEXTENSION)\


HEADERS		=\
		$(LIBFLEXPATH)/flex.h\
		noisy.pb-c.h\
		noisy-types.h\
		noisy-timeStamps.h\
		noisy-lexer.h\
		noisy-parser.h\
		noisy-irHelpers.h\
		noisy-irPass-dotBackend.h\
		noisy-irPass-protobufBackend.h\
		noisy-codeGeneration.h\



all: installhooks common lib$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N).a target $(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) $(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) Makefile examples

common:
	cd ../common && make SYSNAME=Noisy SYSNAMELOWER=noisy

#
#			Install the pre-commit hooks. There doesn't seem to be any other way to force people to install the hook when comitting on Noisy.
#
installhooks:
	cp $(TREEROOT)/hooks/$(PRECOMMITHOOK) $(TREEROOT)/.git/hooks/pre-commit
	cp $(TREEROOT)/hooks/commitMessageHook.sh $(TREEROOT)/.git/hooks/commit-msg
	cp $(TREEROOT)/hooks/postcommitStatisticsHook.sh $(TREEROOT)/.git/hooks/post-commit
	chmod +x $(TREEROOT)/.git/hooks/pre-commit
	chmod +x $(TREEROOT)/.git/hooks/commit-msg
	chmod +x $(TREEROOT)/.git/hooks/post-commit


#
#			Libraries
#
lib$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N).a: $(LIBNOISYOBJS) $(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) $(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) Makefile 
	$(AR) $(ARFLAGS) $@ $(LIBNOISYOBJS)


#
#			Executables
#
target: $(OBJS) $(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) $(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) Makefile 
	$(LD) $(LINKDIRS) $(LDFLAGS) $(OBJS) -lflex-$(OSTYPE) -lm $(LINKDIRS) $(LDFLAGS) -o $(TARGET)


cgi:lib$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N).a $(CGIOBJS) $(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) $(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) Makefile 
	$(LD) -L. -L$(LIBFLEXPATH) $(LDFLAGS) $(CGIOBJS) -lflex-$(OSTYPE) $(LINKDIRS) $(LDFLAGS) -o $(CGI_TARGET)


full: scan README.sloccount


#
#			Objects
#
%.$(OBJECTEXTENSION): %.c #$(HEADERS) $(CONFIGPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) $(COMMONPATH)/config.$(OSTYPE)-$(MACHTYPE).$(COMPILERVARIANT) Makefile 
#	$(SPLINT) $(FLEXFLAGS) $(INCDIRS) $<
#	$(LCLINT) $(FLEXFLAGS) $(INCDIRS) $<
	$(CC) $(FLEXFLAGS) $(INCDIRS) $(CCFLAGS) $(WFLAGS) $(OPTFLAGS) -c $(LINTFLAGS) $<
	$(CC) $(FLEXFLAGS) $(INCDIRS) $(CCFLAGS) $(WFLAGS) $(OPTFLAGS) -c $<

noisy.pb-c.c: noisy.proto Makefile
	$(PROTOC) --c_out=. noisy.proto

noisy.pb-c.h: noisy.pb-c.c

noisy-irPass-protobufBackend.$(OBJECTEXTENSION): noisy-irPass-protobufBackend.c
	$(CC) $(FLEXFLAGS) $(INCDIRS) $(CCFLAGS) `pkg-config --cflags 'libprotobuf-c >= 1.0.0'` $(WFLAGS) $(OPTFLAGS) -c $<

noisy.pb-c.$(OBJECTEXTENSION): noisy.pb-c.c noisy.proto Makefile
	$(CC) $(FLEXFLAGS) $(INCDIRS) $(CCFLAGS) `pkg-config --cflags 'libprotobuf-c >= 1.0.0'` $(WFLAGS) $(OPTFLAGS) -c $<

version.c: $(HEADERS) Makefile
	echo 'char kNoisyVersion[] = "0.3-alpha-'`git rev-list --count HEAD`' ('`git rev-parse HEAD`') (build '`date '+%m-%d-%Y-%H:%M'`-`whoami`@`hostname -s`-`uname -s`-`uname -r`-`uname -m`\)\"\; > version.c

examples: $(EXAMPLES) target
	./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny2.n
	./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny3.n
	./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny8.n

# (array, list, tuple, or set) not supported yet
# ./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny4.n
# ./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny5.n
# ./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny6.n
# ./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny7.n

# Segmentation fault (core dumped)
# ./$(TARGET) $(EXAMPLES_NOISY_FLAGS) $(EXAMPLESPATH)/tiny9.n

scan:	clean
	scan-build --use-cc=$(CC) -k -V make -j4


README.sloccount: $(HEADERS) $(SOURCES)
	sloccount *.c *.h *.grammar *.ffi > README.sloccount


installcgi: cgi
	sudo cp $(CGI_TARGET) $(CGI_BIN)
	sudo mkdir $(HTMLBASEPATH)
	sudo cp ../icons/* $(HTMLBASEPATH)/ 
	sudo chmod 777 $(HTMLBASEPATH) 
	sudo chmod 755 $(HTMLBASEPATH)/*.png

	
test:
	./noisy-$(OSTYPE)-EN --dot ../Examples/noisy/helloWorld.n | dot -Tpdf -O ; open noname.gv.pdf 


clean:
	rm -rf version.c $(OBJS) $(CGIOBJS) $(LIBNOISYOBJS) $(TARGET) $(TARGET).dSYM $(CGI_TARGET) $(CGI_TARGET).dsym lib$(LIBNOISY)-$(OSTYPE)-$(NOISY_L10N).a *.o *.plist noisy.pb-c.c noisy.pb-c.h
	cd ../common && make clean
